{% extends "base.html" %}
{% block content %}

<h1>GitHub Auto Sync – Dashboard</h1>

<p><strong>Projekt:</strong> {{ cfg.project_name }} — <code>{{ cfg.project_path }}</code></p>
<p><strong>Branch:</strong> {{ cfg.branch }} — <strong>Remote:</strong> {{ cfg.remote_url or "—" }}</p>
<p><strong>Status:</strong> {% if running %}<span class="ok">WATCHING</span>{% else %}<span class="off">STOPPED</span>{% endif %}</p>

<form method="post" action="{{ url_for('start_watch') }}" style="display:inline">
  <button type="submit" {% if running %}disabled{% endif %}>Start</button>
</form>
<form method="post" action="{{ url_for('stop_watch') }}" style="display:inline">
  <button type="submit" {% if not running %}disabled{% endif %}>Stop</button>
</form>

<h2>Letzte Ereignisse</h2>
<pre id="log" class="log"></pre>

<script>
  async function refreshLogs() {
    try {
      const res  = await fetch("/api/logs", { cache: "no-store" });
      const data = await res.json();

      let text = "";
      if (typeof data?.text === "string") {
        text = data.text;
      } else if (Array.isArray(data?.lines)) {
        text = data.lines.join("\n");
      }

      text = text.replace(/\\n/g, "\n");
      const el = document.getElementById("log");
      el.textContent = text;
      el.scrollTop = el.scrollHeight;
    } catch (e) { /* still */ }
  }
  refreshLogs();
  setInterval(refreshLogs, 1500);
</script>

  <!-- RAW-Links aus der Vorschau -->
<section class="card mt">
  <header class="card-header">
    <h3>Vorschau (RAW-Links)</h3>
    <div class="copy-row">
      <button id="btnCopyRaw" type="button">Copy</button>
    </div>
  </header>
  <div class="card-body">
    <textarea id="rawList" class="raw-textarea" readonly rows="6" spellcheck="false">
{% for url in preview_raw_urls %}{{ url }}
{% endfor %}
    </textarea>
    {% if not preview_raw_urls %}
      <p class="muted">Keine Dateien in der Vorschau (Watcher gestoppt oder Filter greifen).</p>
    {% endif %}
  </div>
</section>

<script>
  (function () {
    const btn = document.getElementById('btnCopyRaw');
    const ta  = document.getElementById('rawList');
    if (btn && ta) {
      btn.addEventListener('click', async () => {
        try {
          // Inhalt säubern: führende/anhängende Leerzeilen entfernen
          const text = (ta.value || '').trim();
          if (!text) return;
          ta.focus();
          ta.select();
          ta.setSelectionRange(0, text.length);
          await navigator.clipboard.writeText(text);
          btn.textContent = 'Kopiert!';
          setTimeout(() => (btn.textContent = 'Copy'), 1200);
        } catch (e) {
          // Fallback: execCommand (ältere Browser)
          try {
            ta.focus();
            ta.select();
            document.execCommand('copy');
            btn.textContent = 'Kopiert!';
            setTimeout(() => (btn.textContent = 'Copy'), 1200);
          } catch (_) {}
        }
      });
    }
  })();
</script>

{% endblock %}