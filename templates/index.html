{% extends "base.html" %}
{% block content %}

<h1>GitHub Auto Sync – Dashboard</h1>

<p><strong>Projekt:</strong> {{ cfg.project_name }} &mdash; <code>{{ cfg.project_path }}</code></p>
<p><strong>Branch:</strong> {{ cfg.branch }} &mdash; <strong>Remote:</strong> {{ cfg.remote_url or "&mdash;" }}</p>
<p><strong>Status:</strong> {% if running %}<span class="ok">WATCHING</span>{% else %}<span class="off">STOPPED</span>{% endif %}</p>

<section class="card mt-small">
  <header class="card-header">
    <h3>Letzte Ereignisse</h3>
    <div class="copy-row">
      <form method="post" action="{{ url_for('start_watch') }}" style="display:inline">
        <button class="btn" type="submit" {% if running %}disabled{% endif %}>Start</button>
      </form>
      <form method="post" action="{{ url_for('stop_watch') }}" style="display:inline; margin-left:.5rem;">
        <button class="btn" type="submit" {% if not running %}disabled{% endif %}>Stop</button>
      </form>
      <form method="post" action="{{ url_for('manual_push') }}" style="display:inline; margin-left:.5rem;">
        <button class="btn" type="submit" {% if cfg.auto_push %}disabled{% endif %}>Push</button>
      </form>
    </div>
  </header>
  <div class="card-body">
    <pre id="log" class="log"></pre>
  </div>
</section>

<script>
  // Auto-Scroll nur, wenn User "oben" ist
  let logAutoScrollTop = true;

  (function attachLogScrollListener () {
    const el = document.getElementById('log');
    if (!el) return;
    el.addEventListener('scroll', () => {
      const atTop = el.scrollTop <= 8;
      logAutoScrollTop = atTop;
    }, { passive: true });
  })();

  async function refreshLogs() {
    try {
      const el  = document.getElementById("log");
      if (!el) return;

      const res  = await fetch("/api/logs", { cache: "no-store" });
      const data = await res.json();

      let text = "";
      if (typeof data?.text === "string") {
        text = data.text;
      } else if (Array.isArray(data?.lines)) {
        text = data.lines.join("\n");
      }
      text = text.replace(/\\n/g, "\n");

      el.textContent = text;

      if (logAutoScrollTop) {
        el.scrollTop = 0;
      }
    } catch (e) { /* ignore */ }
  }

  refreshLogs();
  setInterval(refreshLogs, 1500);
</script>

<!-- RAW-Links aus der Vorschau -->
<section class="card mt-small">
  <header class="card-header">
    <h3>Vorschau (RAW-Links)</h3>
    <div class="copy-row">
      <button id="btnCopyRaw" type="button" class="btn btn--ghost">Copy</button>
    </div>
  </header>
  <div class="card-body">
    <pre id="rawList" class="log"></pre>
    {% if not preview_raw_urls %}
      <p class="muted">Keine Dateien in der Vorschau (Watcher gestoppt oder Filter greifen).</p>
    {% endif %}
  </div>
</section>

<script>
  // Rendert klickbare RAW-Zeilen ohne zusätzliche Leerzeilen
  function renderRawLines(lines) {
    const pre = document.getElementById("rawList");
    if (!pre) return;
    pre.replaceChildren(); // leeren

    (lines || [])
      .filter(l => l && l.trim() !== "")
      .forEach((url) => {
        const span = document.createElement("span");
        span.className = "raw-line";
        span.textContent = url;
        span.title = "Klicken zum Kopieren";
        span.addEventListener("click", async () => {
          try {
            await navigator.clipboard.writeText(url);
            span.classList.add("copied");
            setTimeout(() => span.classList.remove("copied"), 700);
          } catch {}
        });
        pre.appendChild(span); // kein \n anhängen → keine Leerzeilen
      });
  }

  // RAW-Liste live nachladen
  async function refreshRawLinks() {
    try {
      const res  = await fetch("/api/raw-links", { cache: "no-store" });
      const data = await res.json();
      if (data && data.ok) {
        const lines = Array.isArray(data.lines)
          ? data.lines
          : (data.text || "").split("\n").filter(l => l.trim() !== "");
        renderRawLines(lines);
      }
    } catch { /* still */ }
  }
  refreshRawLinks();
  setInterval(refreshRawLinks, 2000);

  // Copy-Button (kopiert weiterhin ALLE Zeilen)
  (function () {
    const btn = document.getElementById('btnCopyRaw');
    const pre = document.getElementById('rawList');
    if (!btn || !pre) return;

    btn.addEventListener('click', async () => {
      const text = Array.from(pre.querySelectorAll(".raw-line"))
                        .map(el => el.textContent || "")
                        .join("\n")
                        .trim();
      if (!text) return;

      try {
        await navigator.clipboard.writeText(text);
        btn.textContent = 'Kopiert!';
        setTimeout(() => (btn.textContent = 'Copy'), 1200);
      } catch {}
    });
  })();
</script>

{% endblock %}